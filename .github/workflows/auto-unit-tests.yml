name: Generate Apex Tests

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  generate-tests:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find changed Apex classes
        id: find
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }} | grep "\.cls$" || true)
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      - name: Skip if nothing changed
        if: steps.find.outputs.changed == ''
        run: echo "No Apex classes changed."

      - name: Generate tests using GitHub Copilot API
        if: steps.find.outputs.changed != ''
        run: |
          for file in ${{ steps.find.outputs.changed }}; do
            CONTENT=$(cat "$file" | jq -Rs .)

            PAYLOAD=$(jq -n \
              --argjson content "$CONTENT" \
              '{
                model: "gpt-4o",
                messages: [
                  { role: "system", content: "Generate an Apex test class with >90% coverage and best practices. Return ONLY the Apex code without markdown formatting." },
                  { role: "user", content: $content }
                ]
              }')

            RESPONSE=$(curl -s \
              -X POST "https://api.githubcopilot.com/chat/completions" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD")

            RESULT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

            TEST_FILE="${file%.cls}Test.cls"
            echo "$RESULT" > "$TEST_FILE"
          done

      - name: Commit generated tests
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          if git commit -m "Auto-generate Apex test classes"; then
            git push
          else
            echo "No changes to commit."
          fi
