name: Generate Apex Tests

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  generate-tests:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Find changed Apex classes
        id: find
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }} | grep "\.cls$" || true)
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      - name: Skip if nothing changed
        if: steps.find.outputs.changed == ''
        run: echo "No Apex classes changed."

      - name: Setup Node.js
        if: steps.find.outputs.changed != ''
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Generate tests using GitHub Copilot
        if: steps.find.outputs.changed != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Install GitHub CLI if not available
          which gh || (curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null && \
          sudo apt update && sudo apt install gh -y)
          
          for file in ${{ steps.find.outputs.changed }}; do
            if [ -f "$file" ]; then
              echo "Processing $file with GitHub Copilot..."
              
              # Read the file content
              CONTENT=$(cat "$file")
              TEST_FILE="${file%.cls}Test.cls"
              
              # Use GitHub API to call Copilot
              PROMPT="You are an expert Salesforce Apex developer. Generate a comprehensive test class for the following Apex class with >90% code coverage. Include @isTest annotation, @TestSetup method, individual test methods for each public/global method, exception handling tests, and bulk operation tests. Follow Salesforce best practices. Return ONLY valid Apex code without markdown formatting:\n\n\`\`\`apex\n${CONTENT}\n\`\`\`"
              
              # Call GitHub Models API (using gpt-4o)
              RESPONSE=$(curl -s -X POST https://models.inference.ai.azure.com/chat/completions \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -d "{
                  \"messages\": [
                    {
                      \"role\": \"system\",
                      \"content\": \"You are an expert Salesforce Apex test generator.\"
                    },
                    {
                      \"role\": \"user\",
                      \"content\": $(echo "$PROMPT" | jq -Rs .)
                    }
                  ],
                  \"model\": \"gpt-4o\",
                  \"temperature\": 0.3,
                  \"max_tokens\": 4000
                }")
              
              # Extract the generated code
              echo "$RESPONSE" | jq -r '.choices[0].message.content' | sed 's/```apex//g' | sed 's/```//g' > "$TEST_FILE"
              
              if [ -s "$TEST_FILE" ]; then
                echo "✅ Successfully generated: $TEST_FILE"
              else
                echo "⚠️  Copilot API failed, using fallback template generator"
                node .github/scripts/generate-apex-tests.js "$file"
              fi
            fi
          done

      - name: Commit generated tests
        if: steps.find.outputs.changed != ''
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto-generate Apex test classes"
            git push origin HEAD:${{ github.head_ref }}
          fi
