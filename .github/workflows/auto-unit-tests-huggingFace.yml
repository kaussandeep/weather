name: Generate Apex Unit Tests (HF)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  generate-tests:
    runs-on: ubuntu-latest

    permissions:
      contents: write      # required to push changes into PR branch
      pull-requests: write # optional if you want PR comments

    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
      # -------------------------------------------------------
      # 1. Checkout the PR code
      # -------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      # -------------------------------------------------------
      # 2. Install dependencies used to call HuggingFace
      # -------------------------------------------------------
      - name: Install curl + jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # -------------------------------------------------------
      # 3. Detect all Apex classes without tests
      # -------------------------------------------------------
      - name: Find changed Apex classes
        id: find
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }} | grep "\.cls$" | grep -v "Test\.cls$" || true)
          if [ -n "$CHANGED" ]; then
            echo "changed<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "changed=" >> $GITHUB_OUTPUT
          fi

      - name: Skip if nothing changed
        if: steps.find.outputs.changed == ''
        run: echo "No Apex classes changed."

      # -------------------------------------------------------
      # 4. Generate tests using HuggingFace API
      # -------------------------------------------------------
      - name: Generate Tests (huggingface)
        if: steps.find.outputs.changed != ''
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "${{ steps.find.outputs.changed }}" | while IFS= read -r CLASS_FILE; do
            [ -z "$CLASS_FILE" ] && continue
            [ ! -f "$CLASS_FILE" ] && continue
            
            echo "Processing $CLASS_FILE using HuggingFace..."

            BASENAME=$(basename "$CLASS_FILE" .cls)
            CONTENT=$(cat "$CLASS_FILE")
            TEST_FILE="${CLASS_FILE%.cls}Test.cls"

            PROMPT="Generate a complete @isTest Apex test class for the following Apex code. Include setup, positive, negative, and bulk tests:\n\n${CONTENT}"

            echo "Generating tests for $CLASS_FILE"

            RESULT=$(curl -s -X POST "https://api-inference.huggingface.co/models/bigcode/starcoder2-7b" \
                -H "Authorization: Bearer $HF_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{
                    \"inputs\": $(echo "$PROMPT" | jq -Rs .),
                    \"parameters\": { \"max_new_tokens\": 500, \"temperature\": 0.1 }
                }")
            echo "$RESULT" \
              | jq -r '.[0].generated_text // empty' \
              | sed 's/```apex//g' \
              | sed 's/```//g' \
              > "$TEST_FILE"

            if [ -s "$TEST_FILE" ]; then
              echo "✅ Generated: $TEST_FILE"
            else
              echo "⚠️ HuggingFace generation failed, file empty"
              echo "------- API RAW RESPONSE -------"
              echo "$RESULT"
              echo "--------------------------------"
            fi
          done

      # -------------------------------------------------------
      # 6. Commit back to PR
      # -------------------------------------------------------
      - name: Commit Test Files
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          git add .

          if ! git diff --cached --quiet; then
            git commit -m "Auto-generate Apex Unit Tests via HuggingFace API"
            git push origin HEAD:${{ github.head_ref }}
          else
            echo "No new files to commit"
          fi
