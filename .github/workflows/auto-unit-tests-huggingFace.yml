name: Generate Apex Tests (Local AI via Ollama)

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  generate-tests:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      # ------------------------
      # Checkout the PR branch
      # ------------------------
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      # ------------------------
      # Find changed Apex classes
      # ------------------------
      - name: Find changed Apex classes
        id: find
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }} | grep "\.cls$" | grep -v "Test\.cls$" || true)

          if [[ -z "$CHANGED" ]]; then
            echo "changed=" >> $GITHUB_OUTPUT
          else
            echo "changed=$(echo $CHANGED | tr '\n' ' ')" >> $GITHUB_OUTPUT
          fi

      # ------------------------
      # Debug changed files
      # ------------------------
      - name: Debug changed files
        run: |
          echo "Changed files: ${{ steps.find.outputs.changed }}"

      # ------------------------
      # Skip if nothing changed
      # ------------------------
      - name: Skip if nothing changed
        if: steps.find.outputs.changed == ''
        run: echo "✅ No Apex classes changed."

      # ------------------------
      # Install Ollama
      # ------------------------
      - name: Install Ollama
        if: steps.find.outputs.changed && steps.find.outputs.changed != ''
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          sudo systemctl restart ollama
          sleep 5

      # ------------------------
      # Pull the local model
      # ------------------------
      - name: Pull DeepSeek Coder model
        if: steps.find.outputs.changed && steps.find.outputs.changed != ''
        run: |
          ollama pull deepseek-coder:6.7b

      # ------------------------
      # Check Ollama health
      # ------------------------
      - name: Check Ollama health
        if: steps.find.outputs.changed && steps.find.outputs.changed != ''
        run: |
          curl -s http://localhost:11434/api/tags || (echo "❌ Ollama not responding" && exit 1)

      # ------------------------
      # Generate Apex Test Classes
      # ------------------------
      - name: Generate Tests with Local LLM
        if: steps.find.outputs.changed && steps.find.outputs.changed != ''
        run: |
          for file in ${{ steps.find.outputs.changed }}; do
            [ -z "$file" ] && continue

            echo "Processing $file using Local Ollama..."
            CONTENT=$(cat "$file")
            TEST_FILE="${file%.cls}Test.cls"

            PROMPT="You are an expert Salesforce Apex developer. Generate an @isTest Apex test class with >90% coverage for this Apex class. Include:
            - @isTest
            - @TestSetup
            - positive tests
            - negative tests
            - bulk tests
            - exception tests

            Apex class:
            ${CONTENT}"

            # Retry logic for API call
            for i in {1..3}; do
              RESPONSE=$(jq -n --arg model "deepseek-coder:6.7b" --arg prompt "$PROMPT" \
                '{model: $model, prompt: $prompt}' | \
                curl -s -X POST http://localhost:11434/api/generate -d @-)

              echo "Full API response: $RESPONSE"
              TEST_CODE=$(echo "$RESPONSE" | jq -r '.response')

              if [ -n "$TEST_CODE" ] && [ "$TEST_CODE" != "null" ]; then
                echo "$TEST_CODE" > "$TEST_FILE"
                echo "✅ Created: $TEST_FILE"
                break
              else
                echo "Retry $i: Ollama returned empty response"
                sleep 5
              fi
            done

            if [ ! -s "$TEST_FILE" ]; then
              echo "❌ Failed to generate test class for $file"
              echo "::set-output name=failure::true"
            fi
          done

      # ------------------------
      # Commit changes back to PR
      # ------------------------
      - name: Commit generated tests
        if: steps.find.outputs.changed && steps.find.outputs.changed != ''
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto-generate Apex test classes (via Ollama)"
            git push origin HEAD:${{ github.head_ref }}

      # ------------------------
      # Post PR comment if generation failed
      # ------------------------
      - name: Comment on PR if generation failed
        if: steps.generate-tests.outputs.failure == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "⚠️ Failed to generate some Apex test classes using Ollama. Please check workflow logs for details."
            })