name: Generate Apex Tests (Local AI via Ollama)

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  generate-tests:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      # ------------------------
      # Checkout the PR branch
      # ------------------------
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      # ------------------------
      # Find changed Apex classes
      # ------------------------
      - name: Find changed Apex classes
        id: find
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }} | grep "\.cls$" | grep -v "Test\.cls$" || true)

          if [[ -z "$CHANGED" ]]; then
            echo "changed=" >> $GITHUB_OUTPUT
          else
            echo "changed<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Skip if nothing changed
        if: steps.find.outputs.changed == ''
        run: echo "No Apex classes changed."

      # ------------------------
      # Install Ollama
      # ------------------------
      - name: Install Ollama
        if: steps.find.outputs.changed != ''
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          sudo systemctl restart ollama
          sleep 5

      # ------------------------
      # Pull the local model
      # ------------------------
      - name: Pull DeepSeek Coder model
        if: steps.find.outputs.changed != ''
        run: |
          ollama pull deepseek-coder:6.7b

      # ------------------------
      # Generate Apex Test Classes
      # ------------------------
      - name: Generate Tests with Local LLM
        if: steps.find.outputs.changed != ''
        run: |
          echo "${{ steps.find.outputs.changed }}" | while IFS= read -r file; do
            [ -z "$file" ] && continue

            echo "Processing $file using Local Ollama..."
            CONTENT=$(cat "$file")
            TEST_FILE="${file%.cls}Test.cls"

            PROMPT="You are an expert Salesforce Apex developer. Generate an @isTest Apex test class with >90% coverage for this Apex class. Include:
            - @isTest
            - @TestSetup
            - positive tests
            - negative tests
            - bulk tests
            - exception tests

            Apex class:
            ${CONTENT}"

            RESPONSE=$(curl -s http://localhost:11434/api/generate -d "{
              \"model\": \"deepseek-coder:6.7b\",
              \"prompt\": \"${PROMPT}\"
            }")

            echo "$RESPONSE" | jq -r '.response' > "$TEST_FILE"

            if [ -s "$TEST_FILE" ]; then
              echo "✅ Created: $TEST_FILE"
            else
              echo "❌ Failed to generate test class for $file"
            fi
          done

      # ------------------------
      # Commit changes back to PR
      # ------------------------
      - name: Commit generated tests
        if: steps.find.outputs.changed != ''
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto-generate Apex test classes (via Ollama)"
            git push origin HEAD:${{ github.head_ref }}
          fi
